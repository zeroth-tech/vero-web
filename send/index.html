<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vero - Send Verification</title>
    <link rel="stylesheet" href="../style.css"> <!-- Note: Updated path with ../ to access parent directory -->
</head>
<body>
    <div class="container">
        <h1 class="primary-heading">Send Verification Link</h1>
        <p>Choose a sending method below.</p>


        <!-- Sending Options Section -->
        <div class="sending-options">
            <hr class="separator">

            <!-- SMS Section -->
            <section class="send-method">
                <h3>Send via SMS</h3>
                <p>Opens your SMS app with the verification link pre-populated.</p>
                <a href="#" id="sms-link" class="btn btn-primary" target="_blank">Open SMS App</a>
                <p class="note"><small>You'll need to enter the recipient's phone number in your SMS app.</small></p>
                
                <!-- Display session info -->
                <div class="session-info">
                    <p><strong>Session Key:</strong> <span id="display-session-key">Not Provided</span></p>
                    <p><strong>Blink Rate:</strong> <span id="display-blink-rate">Not Provided</span></p>
                    <p><strong>Verification URL:</strong> <a id="display-verification-url" href="#" target="_blank">Not Generated</a></p>
                    <p class="note"><small>(Click the URL above to test it directly)</small></p>
                </div>
            </section>

            <hr class="separator">

            <!-- Email Section -->
            <section class="send-method">
                <h3>Send via Email</h3>
                <p>Opens your email app with the verification link pre-populated.</p>
                <a href="#" id="email-link" class="btn btn-primary" target="_blank">Open Email App</a>
                <p class="note"><small>You'll need to enter the recipient's email address in your email app.</small></p>
           </section>
        </div> <!-- /sending-options -->

         <!-- Link back to configuration page -->
         <div style="margin-top: 30px;">
            <a href="../index.html" class="btn btn-outline">&laquo; Back to Configure</a>
        </div>

    </div> <!-- /container -->

    <!-- JavaScript for this page - modified -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Get URL parameters ---
            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }

            // Get the session key and blink rate from URL parameters
            const sessionKey = getUrlParameter('sessionKey');
            const blinkRate = getUrlParameter('blinkRate');
            // Get or construct verification URL
            let verificationUrl = getUrlParameter('verificationUrl');
            
            // If the verificationUrl isn't provided or doesn't match expected format,
            // construct it using the session key and blink rate
            if (!verificationUrl || !verificationUrl.includes('vero.zeroth.technology')) {
                verificationUrl = `https://vero.zeroth.technology?key=${sessionKey}&rate=${blinkRate}`;
            }

            // Display received parameters
            document.getElementById('display-session-key').textContent = sessionKey || 'Not Provided';
            document.getElementById('display-blink-rate').textContent = blinkRate || 'Not Provided';
            
            // Display the verification URL and make it clickable
            const displayUrlElement = document.getElementById('display-verification-url');
            if (displayUrlElement) {
                displayUrlElement.textContent = verificationUrl || 'Not Generated';
                displayUrlElement.href = verificationUrl || '#';
            }

            // --- SMS Link functionality ---
            const smsLink = document.getElementById('sms-link');
            if (smsLink) {
                // Create SMS link with just the message body
                const smsBody = `Click this link to verify liveness with Vero: ${verificationUrl}`;
                smsLink.href = `sms:?&body=${encodeURIComponent(smsBody)}`;
                
                console.log('SMS Link created with body only');
                console.log('Verification URL:', verificationUrl);
                console.log('Full SMS href:', smsLink.href);
            }

            // --- Email Link functionality ---
            const emailLink = document.getElementById('email-link');
            if (emailLink) {
                // Create email link with subject and body
                const emailSubject = 'Vero Authentication Link';
                const emailBody = `Click this link to verify liveness with Vero: ${verificationUrl}`;
                emailLink.href = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                console.log('Email Link created');
                console.log('Verification URL:', verificationUrl);
                console.log('Full Email href:', emailLink.href);
            }
        });
    </script>
</body>
</html>
